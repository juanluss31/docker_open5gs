#!/bin/bash

help() {
    echo "pySIM and docker_open5gs must be in the same directory"
    
    echo "Use: ./sim-program [options]"
    echo "Options:"
    echo "    card [IMSI last number (0-9)]"
    echo "    coims install [IMSI last number (0-9)]	Install certificates to use CoIMS app"
    echo "    coims list [IMSI last number (0-9)]		List of installed certificates on the SIM"
    echo "    scan					Execute pcsc_scan"
    echo "    help 					Shows pySim help"
}

gp="java -jar $PWD/gp.jar"

OPERATOR=UJA5G
COUNTRY_CODE=0
MCC=001
MNC=01
SMSC=0005555
ACC=0001
IMS_HDOMAIN=ims.mnc$MNC.mcc$MCC.3gppnetwork.org

PIN_ADM=(85903454 42970400 99089163 95466357 67215927 26323548 98936148 83173246 59879048 50381267)
ICCID=(8988211000000535305 8988211000000535313 8988211000000535321 8988211000000535339 8988211000000535347 8988211000000535354 8988211000000535362 8988211000000535370 8988211000000535388 8988211000000535396)
MSISDN=(0001110 0001111 0001112 0001113 0001114 0001115 0001116 0001117 0001118 0001119)
KI=(1B7F04D495107F31E8DF29E5514F28CA 58D702BE6603FA099D468D1296BC4072 EFF1295624972C632BB70D7863A4FC9F C581839E3F6AB86EE564F74150BF5D28 804786B423891CF2A8FA8FBD45E9D237 D1DACEF6CFDEFB4A7B5F7C3225C4D676 32364C8E8C9162E0BFC4FBD7AEADB4AE 95B2689668A3C24443CF45CB7781F066 09498A36425BCE313DC932DEAC3D63CB E6E0652EA80C26E70F6F343BAB533C12)
OPC=(DD71BC1880AF9367E4A52ECABAC326FD 46FB1EA4A7A571F9DCF3E2ABC58FC9FD D97E5A24512DFAEDFE4EA3035AB8CFDE 02A9C1F2B246834BB64F023AA9595FDF F006BC07EC19D737CE0D042F7BBE79AC 8A9EED3E44D4C835121142641E7F836C 45F1BCC5F57668DEEC17C1D7B09C4811 577CB1FDAA2F8C39C4D7618D249C36E9 B8E26F33567C588E103D1BF5FE1F002D C7D61C44E23706765D0457A21A1B803A)
ID=(0000053530 0000053531 0000053532 0000053533 0000053534 0000053535 0000053536 0000053537 0000053538 0000053539)

KIC1=(941DC7B74BEDC136A643CA3621D3772C 808129832B805C59799E82D712DB6421 68BC0B326B792E603B06C3FDCDD4C9BD E688922CA449BE8FCC0272FD4CC2796A 974C94E3B17F8F896FAB46DF48B8DF75 8E53A004B71769FDA6577B65460A3E48 A5F3AB6E6BF4E362479168B7D73E3D2B ADC6B83308091044D3D3513995A28653 4A4C99642BA8D7F0D8F3E5FCF902F997 D4FB40C3C732B1AECFCE3A7591B937D8)

KID1=(D163691A26AEA5D3D4F11EFC27886FA1 A3B6ECE3A4D94FDB7EA3A91FC6690E48 55410BC33C39F6EA8B2917EAF5F43E5E F8B637F54D631935C14F59964D7B9FD8 DD0CC133D2F7AAF17943D7B6E2FFBDC5 F10D4FEDE8FB5DAD05D0ADEC7E575F8F 03A643214A897F250C5A75B453254C0D B59BC0F9FAC7BAFBE1136B8CF5DBF082 EDD330669BA48B7128991319EA186320 ABC49A1ADE23711AFFDAE2ED468D3CB0)

KIK1=(8ACB9DFF5A09D156D62107016C1B5E96 D5EA389093F96E1E0D7FEE5E301FD199 373C3632484966647220A280A697498D 05D1DC6F288727565E499FB0E11C6144 AAC5518556C098A2465DDF5D8AD01D61 36085AD97808EF2D2B0CF64431DCA9EC 1BE4B4D9F1C31A4758796A87B31B6F5F 9F88AD5F2916CB7A867F828E0DF422BF 7872ED7FF230D84C7D365CF632CC60CA 94C2B712C386714032CC0DF141967277)

if [ "$1" == "card" ]; then
    if [[ -n $2 && 0 -le $2 && $2 -le 9 ]]; then
        ../../pysim/pySim-prog.py -p0 -a ${PIN_ADM[$2]} -n $OPERATOR -c $COUNTRY_CODE -x $MCC -y $MNC -m $SMSC -s ${ICCID[$2]} -i ${MCC}${MNC}${ID[$2]} --msisdn=${MSISDN[$2]} -k ${KI[$2]} -o ${OPC[$2]} --acc=$ACC --ims-hdomain=$IMS_HDOMAIN --impi=${MCC}${MNC}${ID[$2]}@$IMS_HDOMAIN --impu="sip:${MCC}${MNC}${ID[$2]}@$IMS_HDOMAIN tel:${MSISDN[$2]} sip:${MSISDN[$2]}@$IMS_HDOMAIN"
    
        exit 1
    fi
fi

if [ "$1" == "coims" ]; then
    if [ "$2" == "install" ]; then
        if [[ -n $3 && 0 -le $3 && $3 -le 9 ]]; then
            alias gp="java -jar $PWD/gp.jar"
            
            $gp --key-enc ${KIC1[$3]} --key-mac ${KID1[$3]} --key-dek ${KIK1[$3]} --install applet.cap
        
            $gp --key-enc ${KIC1[$3]} --key-mac ${KID1[$3]} --key-dek ${KIK1[$3]} -a 00A4040009A00000015141434C0000 -a 80E2900033F031E22FE11E4F06FFFFFFFFFFFFC114E46872F28B350B7E1F140DE535C2A8D5804F0BE3E30DD00101DB080000000000000001
            
            exit 1
        fi
    fi
    
    if [ "$2" == "list" ]; then
        if [[ -n $3 && 0 -le $3 && $3 -le 9 ]]; then
                         
            $gp --key-enc ${KIC1[$3]} --key-mac ${KID1[$3]} --key-dek ${KIK1[$3]} --acr-list-aram
    
            exit 1
        fi
    fi
fi

if [ "$1" == "scan" ]; then

    pcsc_scan
    
    exit 1
fi

if [ "$1" == "help" ]; then

    ../../pysim/pySim-prog.py -help
    
    exit 1
fi

help

exit 1
